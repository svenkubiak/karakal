const api="${api}",appId="${appId}",container=document.getElementById("karakal-auth");if(""===api.trim()&&(console.log("data-api is missing or empty"),container)){container.textContent="";const e=document.createRange().createContextualFragment(error());container.appendChild(e)}if((!appId||""===appId.trim())&&(console.log("data-application-id is missing or empty"),container)){container.textContent="";const t=document.createRange().createContextualFragment(error());container.appendChild(t)}function success(){return'\n<main>\n  <div class="auth-box">\n    <div class="content has-text-centered">\n      <div class="icon is-large has-text-success" style="font-size: 3rem;">✓</div>\n      <h1 class="title is-4 has-text-success">Success!</h1>\n      <p class="subtitle is-6">Your registration was completed successfully.</p>\n    </div>\n    <div class="mt-4 has-text-centered"">\n      <button class="button is-primary is-fullwidth" id="to-login">Sign in now</button>\n    </div>\n</div>\n</main>\n'}function error(){return'\n<main>\n<div class="auth-box">\n    <div class="content has-text-centered">\n      <div class="icon is-large has-text-danger" style="font-size: 3rem;">✕</div>\n      <h1 class="title is-4 has-text-danger">Error!</h1>\n      <p class="subtitle is-6">Oops... something went wrong.<br>Please try again.</p>\n    </div>\n    <div class="mt-4 has-text-centered">\n      <button class="button is-danger is-fullwidth" id="try-again">Try again</button>\n    </div>\n</div>\n</main>\n'}function loginForm(){return'\n<main>\n  <div class="auth-box">\n    <h1 class="title auth-title">Sign In</h1>\n    <p class="auth-subtitle">Please enter your email address to sign in.</p>\n    <form>\n      <div class="field">\n        <label class="label">Email Address</label>\n        <div class="control">\n          <input class="input" id="username" name="username" type="email" placeholder="your@email.com" required autocomplete="username">\n        </div>\n      </div>\n      <button class="button is-link" id="login-init">Sign In</button>\n    </form>\n    <#if registration>\n    <div class="alt-link">\n      Don’t have an account? <a href="#" id="register-form">Register</a>\n    </div>\n    </#if>\n        <div class="alt-link" id="different-account">\n      <a href="#" id="use-different-account">Sign in with another account</a>\n    </div>\n  </div>\n</main>\n'}function registerForm(){return'\n<main>\n  <div class="auth-box" id="register">\n    <h1 class="title auth-title">Register</h1>\n    <p class="auth-subtitle">Create an account to get started.</p>\n      <div class="field">\n        <label class="label">Email Address</label>\n        <div class="control">\n          <input class="input" id="username" name="username" type="email" placeholder="your@email.com" required autocomplete="username">\n        </div>\n      </div>\n      <button class="button is-link" id="register-init">Register</button>\n    </form>\n    <div class="alt-link">\n      Already have an account? <a href="#" id="login-form">Sign In</a>\n    </div>\n  </div>\n</main>\n'}if("https:"!==location.protocol&&alert("This application requires a secure HTTPS connection."),container||console.log("Container element with id 'karakal-auth' does not exist"),api&&""!==api.trim()&&appId&&""!==appId.trim()&&container){function loadCss(e){return new Promise(((t,n)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=e,a.onload=()=>t(),a.onerror=()=>n(new Error("CSS load failed: "+e)),document.head.appendChild(a)}))}function base64urlToBuffer(e){if("string"!=typeof e){if(e instanceof ArrayBuffer)return e;if(ArrayBuffer.isView(e))return e.buffer}let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4;)t+="=";let n=atob(t),a=new Uint8Array(n.length);for(let e=0;e<n.length;e++)a[e]=n.charCodeAt(e);return a.buffer}function bufferToBase64Url(e){let t=new Uint8Array(e),n="";for(let e=0;e<t.length;++e)n+=String.fromCharCode(t[e]);return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function register(e){const t=await fetch("${api}/api/v1/register-init",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,appId:appId})});if(t.ok){const n=await t.json();"object"==typeof n.challenge&&null!==n.challenge&&"value"in n.challenge?n.challenge=base64urlToBuffer(n.challenge.value):"string"==typeof n.challenge&&(n.challenge=base64urlToBuffer(n.challenge)),"string"==typeof n.user.id&&(n.user.id=base64urlToBuffer(n.user.id));const a=await navigator.credentials.create({publicKey:n}),i={id:a.id,rawId:bufferToBase64Url(a.rawId),type:a.type,response:{clientDataJSON:bufferToBase64Url(a.response.clientDataJSON),attestationObject:bufferToBase64Url(a.response.attestationObject)},authenticatorAttachment:a.authenticatorAttachment};if((await fetch("${api}/api/v1/register-complete",{method:"POST",headers:{"Content-Type":"application/json","karakal-username":e,"karakal-app-id":appId},body:JSON.stringify(i)})).ok){container.textContent="";const e=document.createRange().createContextualFragment(success());container.appendChild(e);document.getElementById("to-login").addEventListener("click",(function(e){e.preventDefault(),showForm("login")}))}else{container.textContent="";const e=document.createRange().createContextualFragment(error());container.appendChild(e)}}else{container.textContent="";const e=document.createRange().createContextualFragment(error());container.appendChild(e)}}async function login(e){const t=await fetch("${api}/api/v1/login-init",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,appId:appId})});if(t.ok){const n=await t.json();n.allowCredentials.forEach((e=>{"string"==typeof e.id&&(e.id=base64urlToBuffer(e.id))})),"string"==typeof n.challenge&&(n.challenge=base64urlToBuffer(n.challenge));const a=await navigator.credentials.get({publicKey:n}),i=await fetch("${api}/api/v1/login-complete",{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json","karakal-username":e,"karakal-app-id":appId},credentials:"include"});if(i.ok){localStorage.setItem("username",e);const t=(await i.json()).redirect;window.location.replace(t)}else{container.textContent="";const e=document.createRange().createContextualFragment(error());container.appendChild(e)}}else{container.textContent="";const e=document.createRange().createContextualFragment(error());container.appendChild(e)}}function showForm(e){if("login"===e){container.textContent="";const e=document.createRange().createContextualFragment(loginForm());container.appendChild(e);const t=document.getElementById("username");if(t){const e=localStorage.getItem("username");if(null!=e&&""!==e)t.value=e,document.getElementById("username").disabled=!0;else{const e=document.getElementById("different-account");e&&e.remove()}}const n=document.getElementById("use-different-account");n&&n.addEventListener("click",(e=>{e.preventDefault(),document.getElementById("username").disabled=!1,document.getElementById("username").value="",localStorage.removeItem("username");const t=document.getElementById("different-account");t&&t.remove()}));const a=document.getElementById("login-init");a&&(a.addEventListener("click",(function(e){e.preventDefault();const t=document.getElementById("username").value;t&&login(t)})),document.getElementById("username").addEventListener("keydown",(function(e){if("Enter"===e.key){e.preventDefault();const t=document.getElementById("username").value;t&&login(t)}})));const i=document.getElementById("register-form");i&&i.addEventListener("click",(function(e){e.preventDefault(),showForm("register")}))}else{container.textContent="";const e=document.createRange().createContextualFragment(registerForm());container.appendChild(e);const t=document.getElementById("register-init");t&&(t.addEventListener("click",(function(e){e.preventDefault();const t=document.getElementById("username").value;t&&register(t)})),document.getElementById("username").addEventListener("keydown",(function(e){if("Enter"===e.key){e.preventDefault();const t=document.getElementById("username").value;t&&register(t)}})));const n=document.getElementById("login-form");n&&n.addEventListener("click",(function(e){e.preventDefault(),showForm("login")}))}}console.log("karakal-auth-init complete"),Promise.all([loadCss("${api}/assets/css/bulma.min.css"),loadCss("${api}/api/v1/assets/${appId}/karakal.min.css")]).then((()=>{showForm("login")}));const n=document.getElementById("try-again");n&&n.addEventListener("click",(function(e){e.preventDefault(),showForm("login")}))}