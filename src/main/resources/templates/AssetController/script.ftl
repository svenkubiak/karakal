const api="${api}",appId="${appId}",nonce="${nonce}",localStorageKey="${appId}-username",container=document.getElementById("karakal-auth"),missing=[];if(""===api.trim()&&missing.push("data-api"),appId&&""!==appId.trim()||missing.push("data-application-id"),container||missing.push("karakal-auth container"),missing.length)throw console.log("Missing:",missing.join(", ")),container&&renderFragment(error),new Error("karakal-auth initialization failed: "+missing.join(", "));function success(){return'\n<main>\n  <div class="auth-box">\n    <div class="content has-text-centered">\n      <div class="icon is-large has-text-success" style="font-size: 3rem;">✓</div>\n      <h1 class="title is-4 has-text-success">Success!</h1>\n      <p class="subtitle is-6">Your registration was completed successfully.</p>\n    </div>\n    <div class="mt-4 has-text-centered">\n      <button class="button is-primary is-fullwidth" id="to-login">Sign in now</button>\n    </div>\n</div>\n</main>\n'}function error(){return'\n<main>\n<div class="auth-box">\n    <div class="content has-text-centered">\n      <div class="icon is-large has-text-danger" style="font-size: 3rem;">✕</div>\n      <h1 class="title is-4 has-text-danger">Error!</h1>\n      <p class="subtitle is-6">Oops... something went wrong.<br>Please try again.</p>\n    </div>\n    <div class="mt-4 has-text-centered">\n      <button class="button is-danger is-fullwidth" id="try-again">Try again</button>\n    </div>\n</div>\n</main>\n'}function loginForm(){return'\n<main>\n  <div class="auth-box">\n    <h1 class="title auth-title">Sign In</h1>\n    <p class="auth-subtitle">Please enter your email address to sign in.</p>\n    <form>\n      <div class="field">\n        <label class="label">Email Address</label>\n        <div class="control">\n          <input class="input" id="username" name="username" type="email" placeholder="your@email.com" required autocomplete="username">\n        </div>\n      </div>\n      <button class="button is-link" id="login-init">Sign In</button>\n    </form>\n    <#if registration>\n    <div class="alt-link">\n      Don’t have an account? <a href="#" id="register-form">Register</a>\n    </div>\n    </#if>\n      <div class="alt-link" id="different-account">\n      <a href="#" id="use-different-account">Sign in with another account</a>\n    </div>\n  </div>\n</main>\n'}function registerForm(){return'\n<main>\n  <div class="auth-box" id="register">\n    <h1 class="title auth-title">Register</h1>\n    <p class="auth-subtitle">Create an account to get started.</p>\n    <form>\n      <div class="field">\n        <label class="label">Email Address</label>\n        <div class="control">\n          <input class="input" id="username" name="username" type="email" placeholder="your@email.com" required autocomplete="username">\n        </div>\n      </div>\n      <button class="button is-link" id="register-init">Register</button>\n    </form>\n    <div class="alt-link">\n      Already have an account? <a href="#" id="login-form">Sign In</a>\n    </div>\n  </div>\n</main>\n'}if(api&&""!==api.trim()&&appId&&""!==appId.trim()&&container){function loadCss(e){return new Promise(((n,t)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=e,a.onload=()=>n(),a.onerror=()=>t(new Error("CSS load failed: "+e)),document.head.appendChild(a)}))}function renderFragment(e){container.textContent="";const n=document.createRange().createContextualFragment(e());container.appendChild(n);const t=document.getElementById("try-again");t&&t.addEventListener("click",(function(e){e.preventDefault(),console.log("Try Again"),showForm("login")}))}function base64urlToBuffer(e){if("string"!=typeof e){if(e instanceof ArrayBuffer)return e;if(ArrayBuffer.isView(e))return e.buffer}let n=e.replace(/-/g,"+").replace(/_/g,"/");for(;n.length%4;)n+="=";let t=atob(n),a=new Uint8Array(t.length);for(let e=0;e<t.length;e++)a[e]=t.charCodeAt(e);return a.buffer}function bufferToBase64Url(e){let n=new Uint8Array(e),t="";for(let e=0;e<n.length;++e)t+=String.fromCharCode(n[e]);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function register(e){const n=await fetch("${api}/api/v1/register-init",{method:"POST",headers:{"Content-Type":"application/json","karakal-nonce":nonce},body:JSON.stringify({username:e,appId:appId})});if(n.ok){const t=await n.json();"object"==typeof t.challenge&&null!==t.challenge&&"value"in t.challenge?t.challenge=base64urlToBuffer(t.challenge.value):"string"==typeof t.challenge&&(t.challenge=base64urlToBuffer(t.challenge)),"string"==typeof t.user.id&&(t.user.id=base64urlToBuffer(t.user.id));const a=await navigator.credentials.create({publicKey:t}),i={id:a.id,rawId:bufferToBase64Url(a.rawId),type:a.type,response:{clientDataJSON:bufferToBase64Url(a.response.clientDataJSON),attestationObject:bufferToBase64Url(a.response.attestationObject)},authenticatorAttachment:a.authenticatorAttachment};if((await fetch("${api}/api/v1/register-complete",{method:"POST",headers:{"Content-Type":"application/json","karakal-username":e,"karakal-app-id":appId,"karakal-nonce":nonce},body:JSON.stringify(i)})).ok){renderFragment(success);document.getElementById("to-login").addEventListener("click",(function(e){e.preventDefault(),showForm("login")}))}else renderFragment(error)}else renderFragment(error)}async function login(e){const n=await fetch("${api}/api/v1/login-init",{method:"POST",headers:{"Content-Type":"application/json","karakal-nonce":nonce},body:JSON.stringify({username:e,appId:appId})});if(n.ok){const t=await n.json();t.allowCredentials.forEach((e=>{"string"==typeof e.id&&(e.id=base64urlToBuffer(e.id))})),"string"==typeof t.challenge&&(t.challenge=base64urlToBuffer(t.challenge));const a=await navigator.credentials.get({publicKey:t}),i=await fetch("${api}/api/v1/login-complete",{method:"POST",body:JSON.stringify(a),headers:{"Content-Type":"application/json","karakal-username":e,"karakal-app-id":appId,"karakal-nonce":nonce}});if(i.ok){localStorage.setItem(localStorageKey,e);const n=await i.json(),t=n.name,a=n.jwt,r=n.maxAge,o=n.redirect;document.cookie=encodeURIComponent(t)+"="+encodeURIComponent(a)+"; max-age="+r+"; path=/; SameSite=Strict; Secure",window.location.replace(o)}else renderFragment(error)}else renderFragment(error)}function showForm(e){if("login"===e){renderFragment(loginForm);const e=document.getElementById("username"),n=document.getElementById("use-different-account");if(e){const t=localStorage.getItem(localStorageKey);null!=t&&""!==t?(e.value=t,e.disabled=!0):n&&n.remove()}n&&n.addEventListener("click",(t=>{t.preventDefault(),e.disabled=!1,e.value="",localStorage.removeItem(localStorageKey),n&&n.remove()}));const t=document.getElementById("login-init");t&&(t.addEventListener("click",(function(n){n.preventDefault();const t=e.value;t&&login(t)})),e.addEventListener("keydown",(function(n){if("Enter"===n.key){n.preventDefault();const t=e.value;t&&login(t)}})));const a=document.getElementById("register-form");a&&a.addEventListener("click",(function(e){e.preventDefault(),showForm("register")}))}else{renderFragment(registerForm);const e=document.getElementById("username"),n=document.getElementById("register-init");n&&(n.addEventListener("click",(function(n){n.preventDefault();const t=e.value;t&&register(t)})),e.addEventListener("keydown",(function(n){if("Enter"===n.key){n.preventDefault();const t=e.value;t&&register(t)}})));const t=document.getElementById("login-form");t&&t.addEventListener("click",(function(e){e.preventDefault(),showForm("login")}))}}console.log("karakal-auth-init complete"),Promise.all([loadCss("${api}/assets/css/bulma.min.css"),loadCss("${api}/assets/css/karakal.min.css")]).then((()=>{showForm("login")}))}